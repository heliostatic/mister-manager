#!/usr/bin/env bash
#
# secrets-setup
#
# Interactive setup for migrating secrets to 1Password
# Run this once to set up your secrets infrastructure

set -e

DOTFILES_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
source "$DOTFILES_ROOT/script/lib.sh"

cat << 'EOF'

  Secrets Migration Setup
  ========================

  This script helps you migrate hardcoded secrets to 1Password.

  BEFORE RUNNING THIS SCRIPT:
  1. Install 1Password CLI: brew install 1password-cli
  2. Connect it to your 1Password account: op signin

EOF

# Check prerequisites
if ! has_command op; then
    fail "1Password CLI not installed. Run: brew install 1password-cli"
fi

if ! op account get &>/dev/null; then
    warn "Not signed in to 1Password"
    info "Running: op signin"
    eval "$(op signin)"
fi

success "1Password CLI connected"
echo ""

# Secrets to create in 1Password
cat << 'EOF'
  SECRETS TO CREATE IN 1PASSWORD
  ================================

  You need to create these items in your 1Password vault.
  Use a vault called "Personal" or update script/secrets to match.

  1. "Fastmail App Password"
     - Type: Login
     - Field: password
     - Value: Generate NEW app password at Fastmail > Settings > Privacy & Security

  2. "Fastmail JMAP Token" (if using JMAP)
     - Type: Login
     - Field: credential
     - Value: Generate at Fastmail > Settings > Privacy & Security > API tokens

  3. "Gmail App Password"
     - Type: Login
     - Field: password
     - Value: Generate at Google Account > Security > App passwords

  4. "GitHub CLI Token"
     - Type: Login
     - Field: token
     - Value: Generate at github.com/settings/tokens (select: repo, read:org)

  5. "GitHub Homebrew Token"
     - Type: Login
     - Field: token
     - Value: Same as above, or separate token with minimal scopes

  6. "Sourcehut IRC"
     - Type: Login
     - Field: password
     - Value: Your sr.ht chat password/token

  7. "Raycast" (optional)
     - Type: Login
     - Field: api token
     - Value: From Raycast settings

EOF

if prompt_yes_no "Have you created these items in 1Password?"; then
    echo ""
    info "Testing secrets retrieval..."

    secrets=("fastmail/password" "github/token" "homebrew/token")
    all_ok=true

    for secret in "${secrets[@]}"; do
        if "$DOTFILES_ROOT/script/secrets" get "$secret" &>/dev/null; then
            success "  $secret"
        else
            warn "  $secret - NOT FOUND"
            all_ok=false
        fi
    done

    echo ""

    if [[ "$all_ok" == true ]]; then
        success "All secrets accessible!"

        if prompt_yes_no "Cache secrets to macOS Keychain for offline access?"; then
            "$DOTFILES_ROOT/script/secrets" cache-all
        fi
    else
        warn "Some secrets missing. Create them in 1Password and re-run this script."
    fi
else
    info "Create the items in 1Password, then re-run this script."
fi

echo ""
cat << 'EOF'
  AFTER MIGRATION
  ================

  If you previously had credentials in plaintext config files,
  you should rotate them:

  - GitHub PAT     → github.com/settings/tokens
  - Fastmail       → Fastmail > Settings > Privacy & Security > App Passwords
  - Gmail          → myaccount.google.com/apppasswords
  - Sourcehut      → sr.ht account settings
  - Raycast        → Raycast preferences

  After rotating, update the new values in 1Password.

EOF

success "Setup complete!"
